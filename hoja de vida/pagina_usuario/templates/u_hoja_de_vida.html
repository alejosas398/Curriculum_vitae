{% extends 'base.html' %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    :root {
        --primary-dark: #0f172a;
        --accent-color: #3b82f6;
        --bg-soft: #f8fafc;
        --text-main: #1e293b;
        --border-light: #e2e8f0;
        --sidebar-bg: #f1f5f9;
    }

    body { 
        background-color: var(--bg-soft); 
        font-family: 'Plus Jakarta Sans', sans-serif;
        color: var(--text-main);
    }

    /* --- AJUSTES PARA IMPRESIÓN Y PDF --- */
    @media print {
        .no-print, .btn-edit { display: none !important; }
        body { background: white; padding: 0; }
        .container { max-width: 100% !important; width: 100% !important; margin: 0 !important; }
        .cv-card { box-shadow: none !important; border: 1px solid #eee !important; border-radius: 0; }
        .sidebar { background: #f1f5f9 !important; -webkit-print-color-adjust: exact; }
    }

    .cv-card {
        background: white; border-radius: 24px; overflow: hidden;
        box-shadow: 0 20px 50px rgba(0,0,0,0.05); border: 1px solid white;
        margin-top: 30px; margin-bottom: 50px;
    }

    /* --- ESTILO SIDEBAR --- */
    .sidebar { background: var(--sidebar-bg); padding: 40px 30px; border-right: 1px solid var(--border-light); }
    .profile-img { 
        width: 150px; height: 150px; object-fit: cover; border-radius: 22px; 
        border: 5px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
        margin-bottom: 20px;
    }
    
    .sidebar-label { 
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; 
        color: #64748b; font-weight: 700; margin-top: 25px; display: block; 
        border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; margin-bottom: 12px; 
    }

    /* --- CONTENIDO PRINCIPAL --- */
    .main-content { padding: 45px; }
    .section-header { 
        display: flex; align-items: center; gap: 12px; margin-bottom: 25px; 
        padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; 
    }
    .section-header i { font-size: 1.4rem; color: var(--accent-color); }
    .section-header h5 { font-family: 'Outfit', sans-serif; font-weight: 700; margin: 0; color: var(--primary-dark); text-transform: uppercase; }

    /* --- TARJETAS DE PROYECTOS --- */
    .project-card { 
        background: #ffffff; border-radius: 16px; padding: 20px; 
        border: 1px solid #e2e8f0; transition: all 0.3s ease;
        height: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    .project-card:hover { 
        transform: translateY(-5px); border-color: var(--accent-color);
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    
    .timeline-item { position: relative; padding-left: 30px; border-left: 2px solid var(--border-light); padding-bottom: 25px; }
    .timeline-item::before { 
        content: ''; position: absolute; left: -7px; top: 0; width: 12px; height: 12px; 
        background: var(--accent-color); border-radius: 50%; border: 2px solid white; 
    }
    
    .badge-date { background: #eff6ff; color: #1d4ed8; font-weight: 600; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; }
    .btn-edit { font-size: 0.8rem; text-decoration: none; color: #64748b; }
    .btn-edit:hover { color: var(--accent-color); }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0"><i class="bi bi-file-earmark-person me-2"></i>Hoja de Vida Completa</h4>
        <div class="d-flex gap-2 no-print">
            <a href="{% url 'descargar_cv_pdf' %}" class="btn btn-success rounded-pill px-5 shadow-sm" style="font-weight: 600; font-size: 1rem;">
                <i class="bi bi-file-pdf-fill me-2"></i>Descargar PDF Completo
            </a>
            <button onclick="window.print();" class="btn btn-dark rounded-pill px-4 shadow-sm">
                <i class="bi bi-printer-fill me-2"></i>Imprimir
            </button>
        </div>
    </div>

    <div class="cv-card">
        <div class="row g-0">
            <div class="col-lg-4 sidebar">
                <div class="text-center">
                    {% if perfil.foto %}
                        <img src="{{ perfil.foto.url }}" class="profile-img" alt="Foto">
                    {% else %}
                        <div class="profile-img d-flex align-items-center justify-content-center bg-white mx-auto border">
                            <i class="bi bi-person-fill text-light" style="font-size: 5rem;"></i>
                        </div>
                    {% endif %}
                    
                    <h3 class="fw-bold text-dark mb-1">{{ perfil.user.first_name }} {{ perfil.user.last_name }}</h3>
                    <p class="text-primary fw-bold">{{ perfil.profesion|default:"Profesional" }}</p>
                    
                    {% if es_propietario %}
                        <a href="{% url 'edit_perfil' %}" class="btn btn-sm btn-outline-primary rounded-pill px-3 no-print mb-4">
                            <i class="bi bi-pencil-square"></i> Editar Perfil
                        </a>
                    {% endif %}
                </div>

                <span class="sidebar-label">Contacto</span>
                <div class="small mb-2 text-dark"><i class="bi bi-envelope-at me-2 text-primary"></i> {{ perfil.user.email }}</div>
                <div class="small mb-2 text-dark"><i class="bi bi-telephone me-2 text-primary"></i> {{ perfil.telefono|default:"No disponible" }}</div>
                {% if perfil.telefono_convencional %}<div class="small mb-2 text-dark"><i class="bi bi-telephone me-2 text-primary"></i> {{ perfil.telefono_convencional }}</div>{% endif %}
                {% if perfil.telefono_fijo %}<div class="small mb-2 text-dark"><i class="bi bi-telephone me-2 text-primary"></i> {{ perfil.telefono_fijo }}</div>{% endif %}
                <div class="small mb-2 text-dark"><i class="bi bi-geo-alt me-2 text-primary"></i> {{ perfil.direccion_domicilio|default:"No disponible" }}</div>
                {% if perfil.direccion_trabajo %}<div class="small mb-2 text-dark"><i class="bi bi-briefcase me-2 text-primary"></i> {{ perfil.direccion_trabajo }}</div>{% endif %}
                {% if perfil.sitio_web %}<div class="small mb-2 text-dark"><i class="bi bi-globe me-2 text-primary"></i> <a href="{{ perfil.sitio_web }}" target="_blank" class="text-primary">{{ perfil.sitio_web }}</a></div>{% endif %}

                <span class="sidebar-label">Datos Personales</span>
                {% if perfil.cedula %}<div class="small mb-1 text-dark"><strong>Cédula:</strong> {{ perfil.cedula }}</div>{% endif %}
                {% if perfil.sexo %}<div class="small mb-1 text-dark"><strong>Sexo:</strong> {% if perfil.sexo == 'H' %}Masculino{% elif perfil.sexo == 'M' %}Femenino{% endif %}</div>{% endif %}
                {% if perfil.fecha_nacimiento %}<div class="small mb-1 text-dark"><strong>Nacimiento:</strong> {{ perfil.fecha_nacimiento|date:"d/m/Y" }}</div>{% endif %}
                {% if perfil.lugar_nacimiento %}<div class="small mb-1 text-dark"><strong>Lugar:</strong> {{ perfil.lugar_nacimiento }}</div>{% endif %}
                {% if perfil.nacionalidad %}<div class="small mb-1 text-dark"><strong>Nacionalidad:</strong> {{ perfil.nacionalidad }}</div>{% endif %}
                {% if perfil.estado_civil %}<div class="small mb-1 text-dark"><strong>Estado Civil:</strong> {{ perfil.estado_civil }}</div>{% endif %}
                {% if perfil.licencia_conducir %}<div class="small mb-1 text-dark"><strong>Licencia:</strong> {{ perfil.licencia_conducir }}</div>{% endif %}

                <span class="sidebar-label">Habilidades</span>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    {% for hab in habilidades %}
                        <span class="badge bg-white text-dark border shadow-sm px-2 py-1">{{ hab.nombre }}</span>
                    {% empty %}
                        <small class="text-muted italic">Sin habilidades registradas.</small>
                    {% endfor %}
                </div>

                <span class="sidebar-label">Referencias</span>
                {% for reco in recomendaciones %}
                    <div class="mb-3 p-2 bg-white-50 rounded border-bottom">
                        <strong class="d-block small text-dark">{{ reco.nombre_contacto }}</strong>
                        <small class="text-muted"><i class="bi bi-telephone me-1"></i>{{ reco.telefono_contacto }}</small>
                    </div>
                {% empty %}
                    <small class="text-muted italic">Sin referencias.</small>
                {% endfor %}
            </div>

            <div class="col-lg-8 main-content">
                
                <section class="mb-5">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-briefcase-fill"></i>
                            <h5 class="d-inline ms-2">Experiencia Laboral</h5>
                        </div>
                        {% if es_propietario %}
                        <a href="{% url 'add_experiencia' %}" class="btn btn-sm btn-success rounded-pill no-print"><i class="bi bi-plus-lg"></i> Añadir</a>
                        {% endif %}
                    </div>
                    {% for exp in experiencias %}
                    {% if exp.activo %}
                    <div class="timeline-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <h6 class="fw-bold mb-0 text-dark">{{ exp.puesto|default:exp.cargo }}</h6>
                                <span class="text-primary small fw-semibold">{{ exp.empresa }}</span>
                                {% if exp.lugar_empresa %}<small class="text-muted d-block"><i class="bi bi-geo-alt-fill"></i> {{ exp.lugar_empresa }}</small>{% endif %}
                            </div>
                            <span class="badge-date">{{ exp.fecha_inicio|date:"Y" }} - {{ exp.fecha_fin|date:"Y"|default:"Actualidad" }}</span>
                        </div>
                        <p class="small text-muted mt-2">{{ exp.descripcion }}</p>
                        {% if exp.nombre_contacto_empresarial or exp.email_empresa or exp.sitio_web_empresa %}
                            <div class="small mt-2" style="background: #f8fafc; padding: 10px; border-radius: 8px;">
                                {% if exp.nombre_contacto_empresarial %}<div><strong>Contacto:</strong> {{ exp.nombre_contacto_empresarial }}</div>{% endif %}
                                {% if exp.telefono_contacto_empresarial %}<div><i class="bi bi-telephone"></i> {{ exp.telefono_contacto_empresarial }}</div>{% endif %}
                                {% if exp.email_empresa %}<div><i class="bi bi-envelope"></i> {{ exp.email_empresa }}</div>{% endif %}
                                {% if exp.sitio_web_empresa %}<div><i class="bi bi-globe"></i> {{ exp.sitio_web_empresa }}</div>{% endif %}
                            </div>
                        {% endif %}
                        {% if exp.certificado %}
                            <a href="{% url 'descargar_certificado' 'experiencia' exp.id %}" class="small text-primary mt-2 d-inline-block"><i class="bi bi-file-pdf"></i> Descargar certificado</a>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% empty %}
                        <p class="text-muted small italic">No hay historial laboral.</p>
                    {% endfor %}
                </section>

                <section class="mb-5">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-grid-3x3-gap-fill"></i>
                            <h5 class="d-inline ms-2">Portafolio de Productos y Proyectos</h5>
                        </div>
                        {% if es_propietario %}
                        <a href="{% url 'add_productos' %}" class="btn btn-sm btn-success rounded-pill no-print"><i class="bi bi-plus-lg"></i> Añadir</a>
                        {% endif %}
                    </div>
                    <div class="row g-3">
                        {% for proy in proyectos_productos %}
                            {% if proy.activo %}
                            <div class="col-md-6">
                                <div class="project-card">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="fw-bold text-dark mb-0">{{ proy.titulo }}</h6>
                                        {% if es_propietario %}
                                        <a href="{% url 'edit_productos' proy.id %}" class="btn-edit no-print"><i class="bi bi-pencil-square"></i></a>
                                        {% endif %}
                                    </div>
                                    <span class="badge bg-primary-subtle text-primary mb-2" style="font-size: 0.7rem;">{{ proy.tipo }}</span>
                                    <p class="small text-muted mb-0" style="line-height: 1.5;">{{ proy.descripcion }}</p>
                                    {% if proy.clasificador %}<small class="text-muted d-block mt-2"><i class="bi bi-tags"></i> {{ proy.clasificador }}</small>{% endif %}
                                </div>
                            </div>
                            {% endif %}
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-light border text-center py-4">
                                <i class="bi bi-folder-x fs-2 text-muted d-block mb-2"></i>
                                <p class="text-muted mb-0">No se han cargado proyectos al portafolio actualmente.</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="section-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-mortarboard-fill"></i>
                                <h5 class="d-inline ms-2">Educación</h5>
                            </div>
                            {% if es_propietario %}
                            <a href="{% url 'add_educacion' %}" class="btn btn-sm btn-success rounded-pill no-print"><i class="bi bi-plus-lg"></i> Añadir</a>
                            {% endif %}
                        </div>
                        {% for edu in educaciones %}
                        <div class="mb-3 ps-3 border-start border-3 border-primary">
                            <h6 class="fw-bold mb-0 small text-dark">{{ edu.titulo }}</h6>
                            <small class="text-muted d-block">{{ edu.institucion }}</small>
                            {% if edu.estado %}
                                <span class="badge bg-light text-dark border mt-1" style="font-size: 0.6rem;">{{ edu.estado }}</span>
                            {% endif %}
                        </div>
                        {% empty %}
                            <p class="text-muted small italic">Sin datos académicos.</p>
                        {% endfor %}
                    </div>

                    <div class="col-md-6">
                        <div class="section-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-patch-check-fill"></i>
                                <h5 class="d-inline ms-2">Certificados y Cursos</h5>
                            </div>
                            {% if es_propietario %}
                            <a href="{% url 'add_curso' %}" class="btn btn-sm btn-success rounded-pill no-print"><i class="bi bi-plus-lg"></i> Añadir</a>
                            {% endif %}
                        </div>
                        {% for curso in cursos %}
                        {% if curso.activo %}
                        <div class="mb-3 ps-3 border-start border-3 border-warning">
                            <h6 class="fw-bold mb-0 small text-dark">{{ curso.nombre|default:curso.nombre_curso }}</h6>
                            <small class="text-muted d-block">{{ curso.institucion }}</small>
                            {% if curso.entidad %}<small class="text-muted d-block"><strong>Entidad:</strong> {{ curso.entidad }}</small>{% endif %}
                            {% if curso.total_horas %}<small class="text-muted d-block"><i class="bi bi-clock"></i> {{ curso.total_horas }} horas</small>{% endif %}
                            {% if curso.fecha_inicio %}<small class="text-muted d-block">{{ curso.fecha_inicio|date:"d/m/Y" }} {% if curso.fecha_fin %}- {{ curso.fecha_fin|date:"d/m/Y" }}{% endif %}</small>{% endif %}
                            {% if curso.nombre_contacto_auspicia or curso.email_empresa_patrocinadora %}
                                <div class="small mt-1" style="background: #fff9e6; padding: 6px; border-radius: 6px;">
                                    {% if curso.nombre_contacto_auspicia %}<div>{{ curso.nombre_contacto_auspicia }}</div>{% endif %}
                                    {% if curso.telefono_contacto_auspicia %}<div><i class="bi bi-telephone"></i> {{ curso.telefono_contacto_auspicia }}</div>{% endif %}
                                    {% if curso.email_empresa_patrocinadora %}<div><i class="bi bi-envelope"></i> {{ curso.email_empresa_patrocinadora }}</div>{% endif %}
                                </div>
                            {% endif %}
                            {% if curso.certificado %}
                                <a href="{% url 'descargar_certificado' 'curso' curso.id %}" class="small text-primary mt-1 d-inline-block"><i class="bi bi-file-pdf"></i> Descargar</a>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% empty %}
                            <p class="text-muted small italic">Sin certificaciones.</p>
                        {% endfor %}
                    </div>
                </div>

                <section class="mb-5">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-award-fill"></i>
                            <h5 class="d-inline ms-2">Reconocimientos y Logros</h5>
                        </div>
                        {% if es_propietario %}
                        <a href="{% url 'add_recomendacion' %}" class="btn btn-sm btn-success rounded-pill no-print"><i class="bi bi-plus-lg"></i> Añadir</a>
                        {% endif %}
                    </div>
                    <div class="row g-3">
                        {% for reco in recomendaciones %}
                        {% if reco.activo %}
                        <div class="col-md-6">
                            <div class="project-card">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="fw-bold text-dark mb-0">{{ reco.nombre_contacto }}</h6>
                                        {% if reco.tipo_reconocimiento %}<span class="badge bg-success text-white" style="font-size: 0.7rem;">{{ reco.tipo_reconocimiento }}</span>{% endif %}
                                    </div>
                                </div>
                                {% if reco.entidad_patrocinadora %}<small class="text-muted d-block"><strong>Entidad:</strong> {{ reco.entidad_patrocinadora }}</small>{% endif %}
                                {% if reco.fecha_reconocimiento %}<small class="text-muted d-block"><i class="bi bi-calendar"></i> {{ reco.fecha_reconocimiento|date:"d/m/Y" }}</small>{% endif %}
                                {% if reco.relacion %}<small class="text-muted d-block"><strong>Relación:</strong> {{ reco.relacion }}</small>{% endif %}
                                <small class="text-muted d-block"><i class="bi bi-telephone"></i> {{ reco.telefono_contacto }}</small>
                                {% if reco.descripcion %}<p class="small text-muted mt-2 mb-0">{{ reco.descripcion }}</p>{% endif %}
                                {% if reco.certificado %}
                                    <a href="{{ reco.certificado.url }}" target="_blank" class="small text-primary mt-2 d-inline-block"><i class="bi bi-file-pdf"></i> Certificado</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-light border text-center py-3">
                                <i class="bi bi-award fs-4 text-muted d-block mb-2"></i>
                                <p class="text-muted mb-0 small">Sin reconocimientos registrados.</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <section class="mb-5">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-shop"></i>
                            <h5 class="d-inline ms-2">Venta Garage</h5>
                        </div>
                        {% if es_propietario %}
                        <a href="#" class="btn btn-sm btn-success rounded-pill no-print" onclick="alert('Próximamente')"><i class="bi bi-plus-lg"></i> Añadir</a>
                        {% endif %}
                    </div>
                    <div class="row g-3">
                        {% for venta in ventas_garage %}
                        {% if venta.activo %}
                        <div class="col-md-4">
                            <div class="project-card">
                                <h6 class="fw-bold text-dark mb-2">{{ venta.nombre_producto }}</h6>
                                <div class="mb-2">
                                    {% if venta.estado_producto == "Bueno" %}
                                        <span class="badge bg-success text-white">Bueno</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Regular</span>
                                    {% endif %}
                                </div>
                                <div class="mb-2">
                                    <strong class="text-primary">Precio:</strong> ${{ venta.valor_bien }}
                                </div>
                                {% if venta.descripcion %}<p class="small text-muted mb-0">{{ venta.descripcion }}</p>{% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-light border text-center py-3">
                                <i class="bi bi-shop fs-4 text-muted d-block mb-2"></i>
                                <p class="text-muted mb-0 small">Sin productos en venta.</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>

            </div>
        </div>
    </div>
</div>

{% endblock %}